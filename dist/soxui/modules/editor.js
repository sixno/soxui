(function(){"use strict";function A(){this.version="1.0.0";this.modules=["tpl","pop"];if(typeof soxui!="undefined"&&soxui.$){var f=soxui.$}else{if(typeof jQuery=="undefined"){typeof console=="object"&&console.error("soxpop error: sorry, jQuery is required, you must load it before this script.");return false}if(typeof soxui=="undefined")window["soxui"]={};for(var e in this.modules){if(typeof window["sox"+this.modules[e]]=="undefined"){typeof console=="object"&&console.error("soxpop error: sorry, sox"+this.modules[e]+" is required, you must load it before this script.");return false}window["soxui"][this.modules[e]]=window["sox"+this.modules[e]]}}var t="";var s="";var o="";var a={};var n=this.version;t=document.currentScript?document.currentScript.src:function(){if(soxui.base){return soxui.base+"modules/editor.js"}else{for(var e=document.scripts.length-1;e>0;e--){if(document.scripts[e].src.indexOf("/soxui/modules/editor.js")>0)return document.scripts[e].src}}}();s=t.substring(0,t.lastIndexOf("/")-7)+"images/face/";o=t.substring(0,t.lastIndexOf("/")-7)+"templates/editor/";var l=function(t,i){f.ajax({async:true,type:"GET",url:o+t+".html?v="+n+"."+(new Date).getTime(),success:function(e){a[t]=soxui.tpl.create(e);if(typeof i=="function")i()},error:function(){typeof console=="object"&&console.error("soxeditor error: can`t find the template.")},dataType:"html"})};var d={ie:function(){var e=navigator.userAgent.toLowerCase();return!!window.ActiveXObject||"ActiveXObject"in window?(e.match(/msie\s(\d+)/)||[])[1]||"11":false}()},i="editor",r="soxui-this",u="soxui-show",x="soxui-disabled";this.index=0;this.config={tool:["strong","italic","underline","del","h1","h2","|","left","center","right","|","link","unlink","face","image"],hideTool:[],height:280};this.set=function(e){var t=this;f.extend(true,t.config,e);return t};var m;this.build=function(e,t){t=t||{};var i=this,o=i.config,n="soxui-editor",r=f(typeof e=="string"?"#"+e:e),s="LAY_editor_"+ ++i.index,a=r.next("."+n),l=f.extend({},o,t),c=function(){var i=[],o={};f.each(l.hideTool,function(e,t){o[t]=true});f.each(l.tool,function(e,t){if(L[t]&&!o[t]){i.push(L[t])}});return i.join("")}();m=f(['<div class="'+n+'">','<div class="soxui-unselect soxui-editor-tool">'+c+"</div>",'<div class="soxui-editor-iframe">','<iframe id="'+s+'" name="'+s+'" textarea="'+e+'" frameborder="0"></iframe>',"</div>","</div>"].join(""));if(d.ie&&d.ie<8){return r.removeClass("soxui-hide").addClass(u)}a[0]&&a.remove();p.call(i,m,r[0],l);r.addClass("soxui-hide").after(m);return i.index};this.getContent=function(e){var t=c(e);if(!t[0])return;return h(t[0].document.body.innerHTML)};this.getText=function(e){var t=c(e);if(!t[0])return;return f(t[0].document.body).text()};this.setContent=function(e,t,i){var o=c(e);if(!o[0])return;if(i){f(o[0].document.body).append(t)}else{f(o[0].document.body).html(t)}A.sync(e)};this.sync=function(e){var t=c(e);if(!t[0])return;var i=f("#"+t[1].attr("textarea"));i.val(h(t[0].document.body.innerHTML))};this.getSelection=function(e){var t=c(e);if(!t[0])return;var i=b(t[0].document);return document.selection?i.text:i.toString()};var p=function(r,s,a){var l=this,c=r.find("iframe");c.css({height:a.height}).on("load",function(){var e=c.contents(),t=c.prop("contentWindow"),i=e.find("head"),o=f(["<style>","*{margin: 0; padding: 0;}","body{padding: 10px; line-height: 20px; overflow-x: hidden; word-wrap: break-word; font: 14px Helvetica Neue,Helvetica,PingFang SC,Microsoft YaHei,Tahoma,Arial,sans-serif; -webkit-box-sizing: border-box !important; -moz-box-sizing: border-box !important; box-sizing: border-box !important;}","h1,h2,h3,h4,h5,h6{margin-bottom: 10px;}","a{color:#01AAED; text-decoration:none;}a:hover{color:#c00}","p{margin-bottom: 10px;}","img{display: inline-block; border: none; vertical-align: middle;}","pre{margin: 10px 0; padding: 10px; line-height: 20px; border: 1px solid #ddd; border-left-width: 6px; background-color: #F2F2F2; color: #333; font-family: Courier New; font-size: 12px;}","</style>"].join("")),n=e.find("body");i.append(o);n.attr("contenteditable","true").css({"min-height":a.height}).html(s.value||"");v.apply(l,[t,c,s,a]);w.call(l,t,r,a)})},c=function(e){var t=f("#sox_editor_"+e),i=t.prop("contentWindow");return[i,t]},h=function(e){if(d.ie==8){e=e.replace(/<.+>/g,function(e){return e.toLowerCase()})}return e},v=function(t,e,i,o){var r=t.document,n=f(r.body);n.on("keydown",function(e){var t=e.keyCode;if(t===13){var i=b(r);var o=y(i),n=o.parentNode;if(n.tagName.toLowerCase()==="pre"){if(e.shiftKey)return;soxui.pop.msg("请暂时用shift+enter");return false}switch(n.tagName.toLowerCase()){case"h1":m.find(".soxui-editor-tool .editor-tool-h1").removeClass("editor-tool-active");break;case"h2":m.find(".soxui-editor-tool .editor-tool-h2").removeClass("editor-tool-active");break;default:r.execCommand("formatBlock",false,"<p>");break}}});f(i).parents("form").on("submit",function(){var e=n.html();if(d.ie==8){e=e.replace(/<.+>/g,function(e){return e.toLowerCase()})}i.value=e});n.on("paste",function(e){r.execCommand("formatBlock",false,"<p>");setTimeout(function(){g.call(t,n);i.value=n.html()},100)})},g=function(e){var t=this,i=t.document;e.find("*[style]").each(function(){var e=this.style.textAlign;this.removeAttribute("style");f(this).css({"text-align":e||""})});e.find("table").addClass("soxui-table");e.find("script,link").remove()},b=function(e){return e.selection?e.selection.createRange():e.getSelection().getRangeAt(0)},y=function(e){return e.endContainer||e.parentElement().childNodes[0]},k=function(e,t,i){var o=this.document,n=document.createElement(e);for(var r in t){n.setAttribute(r,t[r])}n.removeAttribute("text");if(o.selection){var s=i.text||t.text;if(e==="a"&&!s)return;if(s){n.innerHTML=s}i.pasteHTML(f(n).prop("outerHTML"));i.select()}else{var s=i.toString()||t.text;if(e==="a"&&!s)return;if(s){n.innerHTML=s}i.deleteContents();i.insertNode(n)}},C=function(t,e){var i=this.document,o="editor-tool-active",n=y(b(i)),r=function(e){return t.find(".editor-tool-"+e)};if(e){e[e.hasClass(o)?"removeClass":"addClass"](o)}t.find(">i").removeClass(o);r("unlink").addClass(x);f(n).parents().each(function(){var e=this.tagName.toLowerCase(),t=this.style.textAlign;switch(e){case"b":case"strong":r("b").addClass(o);break;case"i":case"em":r("i").addClass(o);break;case"u":r("u").addClass(o);break;case"strike":r("d").addClass(o);break;case"h1":case"h2":r(e).addClass(o);case"p":if(t==="center"){r("center").addClass(o)}else if(t==="right"){r("right").addClass(o)}else{r("left").addClass(o)}break;case"a":r("link").addClass(o);r("unlink").removeClass(x);break}})},w=function(a,e,l){var s=a.document,c=f(s.body),d={link:function(i){var e=y(i),o=f(e).parent();_.call(c,{text:document.selection?i.text:i.toString(),href:o.attr("href")||"",target:o.attr("target")||""},function(e){var t=o[0];if(t.tagName==="A"){t.href=e.href}else{if(e.text==="")e.text=e.href;k.call(a,"a",e,i)}})},unlink:function(e){s.execCommand("unlink")},face:function(t){j.call(this,function(e){k.call(a,"img",{src:e.src,alt:e.alt},t)})},image:function(s){var e=f(f(this).find("input")[0]);e.unbind("change");e.change(function(e){if(!l.uploadImage){this.value="";soxui.pop.msg("未设置上传参数");return}if(this.files.length>0){var i=soxui.pop.load(2);var o=l.uploadImage;var t={".jpg":1,".jpeg":1,".png":1,".gif":1,".bmp":1};var n=this.value.substr(this.value.lastIndexOf(".")).toLowerCase();if(!t[n]){soxui.pop.msg("非图片文件");return}if(o.size&&this.files[0].size>o.size*1024){soxui.pop.msg("文件大小超过"+o.size+"KB");return}var r=new FormData;r.append(o.file||"file",this.files[0]);this.value="";f.ajax({url:o.url,type:"POST",crossDomain:true,xhrFields:{withCredentials:true},data:r,cache:false,contentType:false,processData:false,success:function(e){soxui.pop.close(i);var t=o.data(e);if(t){k.call(a,"img",t,s)}else{soxui.pop.msg("图片上传失败")}},error:function(){soxui.pop.close(i);soxui.pop.msg("图片上传失败")},dataType:"json"})}else{soxui.pop.msg("未选中文件");this.value=""}})},code:function(t){T.call(c,function(e){k.call(a,"pre",{text:e.code,"lay-lang":e.lang},t)})},help:function(){soxui.pop.open({type:2,title:"帮助",area:["600px","380px"],shadeClose:true,shade:.1,skin:"soxui-layer-msg",content:"http://www.soxui.com/#bW9kdWxlL2VkaXRvcnx8"})}},u=e.find(".soxui-editor-tool"),i=function(){var e=f(this),t=e.attr("editor-event"),i=e.attr("lay-command");if(e.hasClass(x))return;c.focus();var o=b(s),n=o.commonAncestorContainer;if(i){switch(i){case"heading":if(e.hasClass("editor-tool-active")){s.execCommand("formatBlock",false,"<p>")}else{s.execCommand("formatBlock",false,"<"+t+">")}break;default:s.execCommand(i);break}if(/justifyLeft|justifyCenter|justifyRight/.test(i)){var r=n.parentNode.tagName.toLowerCase();switch(r){case"h1":case"h2":s.execCommand("formatBlock",false,"<"+r+">");break;default:s.execCommand("formatBlock",false,"<p>");break}}setTimeout(function(){c.focus()},10)}else{d[t]&&d[t].call(this,o)}C.call(a,u,e)},o=/image/;u.find(">i").on("mousedown",function(){var e=f(this),t=e.attr("editor-event");if(o.test(t))return;i.call(this)}).on("click",function(){var e=f(this),t=e.attr("editor-event");if(!o.test(t))return;i.call(this)});c.on("click",function(){C.call(a,u);soxui.pop.close(j.index)})},_=function(e,r){var t=this;var i={type:1,id:"LAY_editor_link",area:"350px",shade:.05,shadeClose:true,moveType:1,title:"超链接",skin:"soxui-layer-msg",content:"",success:function(e,n){e.find(".btn").on("click",function(){var e=f(this);if(e.attr("sox-filter")=="editor-ok"){var t=f("#"+e.attr("sox-editor")).serializeArray();var i={};for(var o in t){i[t[o].name]=t[o].value}r&&r(i)}soxui.pop.close(n)})}};if(a["editor_tool_link"]){i.content=soxui.tpl.render(a["editor_tool_link"],e);_.index=soxui.pop.open(i)}else{l("editor_tool_link",function(){i.content=soxui.tpl.render(a["editor_tool_link"],e);_.index=soxui.pop.open(i)})}},j=function(i){var e=this;var t=s;var o=["[微笑]","[嘻嘻]","[哈哈]","[可爱]","[可怜]","[挖鼻]","[吃惊]","[害羞]","[挤眼]","[闭嘴]","[鄙视]","[爱你]","[泪]","[偷笑]","[亲亲]","[生病]","[太开心]","[白眼]","[右哼哼]","[左哼哼]","[嘘]","[衰]","[委屈]","[吐]","[哈欠]","[抱抱]","[怒]","[疑问]","[馋嘴]","[拜拜]","[思考]","[汗]","[困]","[睡]","[钱]","[失望]","[酷]","[色]","[哼]","[鼓掌]","[晕]","[悲伤]","[抓狂]","[黑线]","[阴险]","[怒骂]","[互粉]","[心]","[伤心]","[猪头]","[熊猫]","[兔子]","[ok]","[耶]","[good]","[NO]","[赞]","[来]","[弱]","[草泥马]","[神马]","[囧]","[浮云]","[给力]","[围观]","[威武]","[奥特曼]","[礼物]","[钟]","[话筒]","[蜡烛]","[蛋糕]"];var n="";var r={tips:1,time:0,skin:"soxui-box soxui-util-face",nomc:true,maxWidth:500,success:function(e,t){e.css({marginTop:-4,marginLeft:-10}).find(".soxui-clear>li").on("click",function(){var e=f(this).find("img");i&&i({src:e.attr("src"),alt:e.attr("alt")});soxui.pop.close(t)});f(document).off("click",j.hide).on("click",j.hide)}};j.hide=j.hide||function(e){if(j.index>0&&f(e.target).attr("editor-event")!=="face"){soxui.pop.close(j.index);j.index=0}};if(a["editor_tool_face"]){n=soxui.tpl.render(a["editor_tool_face"],{path:t,alts:o});j.index=soxui.pop.tips(n,e,r)}else{l("editor_tool_face",function(){r.content=soxui.tpl.render(a["editor_tool_face"],{path:t,alts:o});j.index=soxui.pop.tips(n,e,r)})}},T=function(r){var e=this;var t={type:1,id:"LAY_editor_code",area:"550px",shade:.05,shadeClose:true,moveType:1,title:"插入代码",skin:"soxui-layer-msg",content:"",success:function(e,n){e.find(".btn").on("click",function(){var e=f(this);if(e.attr("sox-filter")=="editor-ok"){var t=f("#"+e.attr("sox-editor")).serializeArray();var i={};for(var o in t){i[t[o].name]=t[o].value}r&&r(i)}soxui.pop.close(n)})}};if(a["editor_tool_code"]){t.content=soxui.tpl.render(a["editor_tool_code"]);T.index=soxui.pop.open(t)}else{l("editor_tool_code",function(){t.content=soxui.tpl.render(a["editor_tool_code"]);T.index=soxui.pop.open(t)})}},L={html:'<i class="soxui-icon editor-tool-html" title="HTML源代码" lay-command="html" editor-event="html"">&#xe64b;</i>',strong:'<i class="soxui-icon editor-tool-b" title="加粗" lay-command="Bold" editor-event="b"">&#xe62b;</i>',italic:'<i class="soxui-icon editor-tool-i" title="斜体" lay-command="italic" editor-event="i"">&#xe644;</i>',underline:'<i class="soxui-icon editor-tool-u" title="下划线" lay-command="underline" editor-event="u"">&#xe646;</i>',del:'<i class="soxui-icon editor-tool-d" title="删除线" lay-command="strikeThrough" editor-event="d"">&#xe64f;</i>',h1:'<i class="soxui-icon editor-tool-h1" title="大标题" lay-command="heading" editor-event="h1""><b>H1</b></i>',h2:'<i class="soxui-icon editor-tool-h2" title="小标题" lay-command="heading" editor-event="h2""><b>H2</b></i>',"|":'<span class="editor-tool-mid"></span>',left:'<i class="soxui-icon editor-tool-left" title="左对齐" lay-command="justifyLeft" editor-event="left"">&#xe649;</i>',center:'<i class="soxui-icon editor-tool-center" title="居中对齐" lay-command="justifyCenter" editor-event="center"">&#xe647;</i>',right:'<i class="soxui-icon editor-tool-right" title="右对齐" lay-command="justifyRight" editor-event="right"">&#xe648;</i>',link:'<i class="soxui-icon editor-tool-link" title="插入链接" editor-event="link"">&#xe64c;</i>',unlink:'<i class="soxui-icon editor-tool-unlink soxui-disabled" title="清除链接" lay-command="unlink" editor-event="unlink"">&#xe64d;</i>',face:'<i class="soxui-icon editor-tool-face" title="表情" editor-event="face"">&#xe650;</i>',image:'<i class="soxui-icon editor-tool-image" title="图片" editor-event="image">&#xe64a;<input type="file" name="file"></i>',code:'<i class="soxui-icon editor-tool-code" title="插入代码" editor-event="code">&#xe64e;</i>',help:'<i class="soxui-icon editor-tool-help" title="帮助" editor-event="help">&#xe607;</i>'}}if(typeof soxui!="undefined"){soxui.editor=new A}else{window.soxeditor=new A}})();